name: Deploy to S3

# Trigger the action on push or pull request to main or develop branches
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step to check out the repository
      - name: Checkout repository
        uses: actions/checkout@v2

      # Step to configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: 'ap-southeast-2'  # Specify your AWS region

      # Step to set up Google Cloud credentials
      - name: Configure Google Cloud credentials
        run: |
          echo "${{ secrets.GOOGLE_CREDENTIALS }}" > $HOME/gcloud.json
          gcloud auth activate-service-account --key-file=$HOME/gcloud.json
        env:
          GOOGLE_APPLICATION_CREDENTIALS: $HOME/gcloud.json

      # Set environment variables
      - name: Set environment variables
        run: echo "CREDENTIALS_PATH=$HOME/gcloud.json" >> $GITHUB_ENV

      # Sync files to S3 bucket
      - name: Sync files to S3
        run: aws s3 sync ./ s3://$AWS_S3_BUCKET --delete
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          CREDENTIALS_PATH: ${{ env.CREDENTIALS_PATH }}
